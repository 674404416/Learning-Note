# 分析TCP的三次握手和四次握手



### 1.三次握手（建立连接时）

​	**目的：**确保服务器和客户端互相确认能否发送，接收。同时互相获取序列号和确认号，以及动态设置滑动窗口大小。

​	

​	**过程（图取自网络）**

![img](https://img-blog.csdn.net/20180717202520531?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

​		

1.客户端发给服务器一个 syn+seq

2.服务器发送给客户端syn和ack以及seq

3.客户端发送给服务器ack和seq



syn，seq，ack是tcp标志位。syn是建立联机，ack是确认，seq是顺序号码。

ack=上一次的seq+1



**问题：三次握手有什么作用（分别是1,2,3次握手的作用）**

​	1.完成后服务器得知：客户端的发送正常，服务器的接收正常。

​	2.完成后客户端得知：服务器的发送正常，接收正常。我的发送正常，接收正常。

​		完成后服务器得知：客户端的发送正常。服务器的接收正常。

​	3.完成后服务器得知：服务器的发送正常，客户端的接收正常。客户端的发送正常，服务器的接收正常。



**状态变化**

​	最初客户端是closed状态，服务器是listen状态。

​	第一次握手之后，客户端给服务器发送syn报文，并指明初始seq（随机值）。然后客户端处于SYN——Send状态

​	第二次握手，服务器收到客户端的SYN，发送自己的SYN报文（包含自己的初始seq）。此时服务器是SYN_REVD状态

​	第三次握手，客户端收到之后让自己处于establised状态。服务器收到客户端发的ack之后业年产establised状态。



### 2.四次握手（断开连接时）

为什么连接时是三次握手，断开时是四次握手？

其实都是四次握手，只不过连接时，服务器把两次合为了一次。

![img](https://img-blog.csdn.net/20180717204202563?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

断开时，把中间分为了两次（ack和fin分开发）

fin是结束标识符

**状态变换**

假设由客户端提出结束连接

​	首先客户端给服务器发送fin和seq，此时客户端变成FIN_WAIT1状态

​	然后服务器给客户端发送确认信号ack以及seq地址（但是不发送fin，因为服务器还没想断开连接），然后服务器变成CLOSE_WAIT状态

​	然后等服务器想发送关闭连接了，服务器发送fin变成LAST-ACK状态

​	客户端收到后发送ack，之后变成TIME-WAIT状态，等待1或者2个报文时间段之后，变成CLOSED状态

​	服务器收到ack之后，变成CLOSED状态



**问题：为什么服务器ack和fin不一起发送？**

当服务器收到客户端传来的断开连接后，发送ack表示回应。但是不发送fin，因为文件在网络中传输速度不是相等的（并不是先传的一定先到）所以服务器要等待一段时间，确认没有信息在发送给客户端之后在发送fin（如果有一起发送）。



**问题：为什么发起方（客户端）要有一个TIME-WAIT阶段，而不是立即CLOSED**

如果客户端最后发给服务器的ack丢失了，那么服务器就会重发fin，如果客户端在TIME-WAIT阶段收到重发的FIN证明，自己发送的ACK丢失，就有时间重新发送ACK来确保信息的正确传递。



**问题：建立好连接之后客户端出现故障怎么办**

服务器有个定时器，如果超过一个时限没有收到客户端发来的任何消息，就发送探测报文。一直没用回复就中断连接。





### 3.TCP发送的报文

![img](https://img-blog.csdn.net/20180717201939345?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)



序列号seq：占4个字节，用来标记数据段的顺序，TCP把连接中发送的所有数据字节都编上一个序号，第一个字节的编号由本地随机产生；给字节编上序号后，就给每一个报文段指派一个序号；序列号seq就是这个报文段中的第一个字节的数据编号。

确认号ack：占4个字节，期待收到对方下一个报文段的第一个数据字节的序号；序列号表示报文段携带数据的第一个字节的编号；而确认号指的是期望接收到下一个字节的编号；因此当前报文段最后一个字节的编号+1即为确认号。
    
确认ACK：占1位，仅当ACK=1时，确认号字段才有效。ACK=0时，确认号无效
    
同步SYN：连接建立时用于同步序号。当SYN=1，ACK=0时表示：这是一个连接请求报文段。若同意连接，则在响应报文段中使得SYN=1，ACK=1。因此，SYN=1表示这是一个连接请求，或连接接受报文。SYN这个标志位只有在TCP建产连接时才会被置1，握手完成后SYN标志位被置0。
    
终止FIN：用来释放一个连接。FIN=1表示：此报文段的发送方的数据已经发送完毕，并要求释放运输连接
    
PS：ACK、SYN和FIN这些大写的单词表示标志位，其值要么是1，要么是0；ack、seq小写的单词表示序号。

